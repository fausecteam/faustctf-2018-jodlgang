stages:
  - build

build_job:
  stage: build
  image: "debian:stretch"
  before_script:
    - mkdir -p "$CI_PROJECT_DIR/.apt" "$CI_PROJECT_DIR/.pip"
    - echo 'deb http://ftp.debian.org/debian stretch-backports main' >> /etc/apt/sources.list
    - apt -o dir::cache="$CI_PROJECT_DIR/.apt" -yqq update
    - apt -o dir::cache="$CI_PROJECT_DIR/.apt" -yqq install python3 python3-venv python3-dev
    - apt -o dir::cache="$CI_PROJECT_DIR/.apt" -yqq install nginx
  cache:
    paths:
      - .apt/
      - .pip/
  script:
    - python3 -m venv dist_root/srv/jodlgang/jodlenv
    - dist_root/srv/jodlgang/jodlenv/bin/pip install -r requirements.txt
  artifacts:
    paths:
      - metadata.yml
      - dist_root/
  only:
    - master
  tags:
    - faust
    - docker